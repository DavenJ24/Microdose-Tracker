<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    <meta name="theme-color" content="#121212" />
    <title>EchoSage Microdose Tracker</title>
    <link rel="manifest" href="manifest.webmanifest" />
    <!-- Link our styles and a simple reset -->
    <link rel="stylesheet" href="styles.css" />
    <script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script defer src="app.js"></script>
  </head>
  <body class="dark">
    <header>
      <h1>EchoSage Microdose Tracker</h1>
    </header>

    <!-- Main application container with tabbed sections -->
    <main id="app">
      <!-- Home / Summary -->
      <section id="home" class="active">
        <h2>Home &amp; Summary</h2>
        <p class="intro">
          This screen shows an overview of your tracking data: daily entries, mood and anxiety trends, sleep, stress and finger tapping speed. Use it to notice patterns over time.
        </p>
        <div class="stats" id="statsSummary">
          <!-- Summary numbers will be injected here -->
        </div>
        <div class="charts">
          <canvas id="chartMood" aria-label="Mood over time" role="img"></canvas>
          <canvas id="chartAnxiety" aria-label="Anxiety over time" role="img"></canvas>
          <canvas id="chartStress" aria-label="Stress over time" role="img"></canvas>
          <canvas id="chartSleep" aria-label="Sleep hours over time" role="img"></canvas>
          <canvas id="chartFtt" aria-label="Finger tapping averages" role="img"></canvas>
        </div>
      </section>

      <!-- Baseline intake -->
      <section id="baseline">
        <h2>Baseline Intake</h2>
        <p class="intro">Before you begin dosing, fill out your baseline information and complete these questionnaires. They help establish a starting point for measuring change.</p>
        <form id="baselineForm">
          <fieldset>
            <legend>Your details</legend>
            <label>
              Initials
              <input type="text" id="blInitials" maxlength="3" placeholder="ABC" />
            </label>
            <label>
              Age
              <input type="number" id="blAge" min="12" max="120" />
            </label>
            <label>
              Height (cm)
              <input type="number" id="blHeight" min="100" max="250" />
            </label>
            <label>
              Weight (kg)
              <input type="number" id="blWeight" min="30" max="300" />
            </label>
            <label>
              Hand dominance
              <select id="blHand">
                <option value="right">Right</option>
                <option value="left">Left</option>
                <option value="both">Both / ambidextrous</option>
              </select>
            </label>
            <label>
              Primary goals
              <select multiple id="blGoals">
                <option value="focus">Improve focus</option>
                <option value="mood">Boost mood</option>
                <option value="sleep">Better sleep</option>
                <option value="anxiety">Reduce anxiety</option>
                <option value="pain">Pain relief</option>
              </select>
            </label>
            <label>
              Choose protocol
              <select id="blProtocol">
                <option value="fadiman">Fadiman (1 on / 2 off)</option>
                <option value="stamets">Stamets (4 on / 3 off)</option>
                <option value="custom">Custom</option>
              </select>
            </label>
            <div id="customPattern" class="hidden">
              <p>Select your custom 7‑day pattern (1 = dose day, 0 = off):</p>
              <div class="day-pattern" id="patternInputs">
                <!-- pattern toggles inserted here by app.js -->
              </div>
            </div>
          </fieldset>

          <!-- PHQ-9 questionnaire -->
          <fieldset class="scale" id="phq9-fieldset">
            <legend>PHQ‑9 (Depression)</legend>
            <p class="scale-explain">The PHQ‑9 screens for symptoms of depression over the past two weeks. Select the option that best describes how often you've been bothered by each problem.</p>
            <div class="questions" id="phq9-questions">
              <!-- questions added via JS -->
            </div>
          </fieldset>

          <!-- GAD-7 questionnaire -->
          <fieldset class="scale" id="gad7-fieldset">
            <legend>GAD‑7 (Anxiety)</legend>
            <p class="scale-explain">The GAD‑7 assesses symptoms of anxiety in the past two weeks. Choose how often each statement applied to you.</p>
            <div class="questions" id="gad7-questions"></div>
          </fieldset>

          <!-- PSS-10 questionnaire -->
          <fieldset class="scale" id="pss10-fieldset">
            <legend>PSS‑10 (Stress)</legend>
            <p class="scale-explain">The Perceived Stress Scale measures how unpredictable, uncontrollable and overloaded you feel. Rate how often you felt a certain way in the last month.</p>
            <div class="questions" id="pss10-questions"></div>
          </fieldset>

          <!-- WHO-5 questionnaire -->
          <fieldset class="scale" id="who5-fieldset">
            <legend>WHO‑5 (Well‑being)</legend>
            <p class="scale-explain">The WHO‑5 captures your general sense of well‑being. Think about the last two weeks and select the option that matches how you've felt.</p>
            <div class="questions" id="who5-questions"></div>
          </fieldset>

          <!-- FTT practice instructions -->
          <fieldset>
            <legend>Finger Tapping Practice</legend>
            <p>To practice the Finger Tapping Test, place your phone on a flat surface. Tap with your index finger as fast as you can for 10 seconds. You'll perform three trials for each hand in the Cognition section.</p>
          </fieldset>

          <button type="button" id="saveBaseline">Save Baseline</button>
        </form>
        <div id="baselineSummary" class="hidden"></div>
      </section>

      <!-- Dosing Log -->
      <section id="dosing">
        <h2>Dosing Log</h2>
        <p class="intro">Record each dosing event here. Capturing dose amount, context and any immediate notes helps you correlate changes later.</p>
        <form id="doseForm">
          <label>
            Date &amp; time
            <input type="datetime-local" id="doseDate" />
          </label>
          <label>
            Dose amount
            <input type="number" id="doseAmount" step="0.01" />
            <select id="doseUnit">
              <option value="g">g</option>
              <option value="mg">mg</option>
            </select>
          </label>
          <label>
            Substance/form
            <select id="doseSubstance">
              <option value="psilocybin">Psilocybin microdose</option>
              <option value="lionsmane">Lion’s mane</option>
              <option value="niacin">Niacin</option>
              <option value="other">Other</option>
            </select>
          </label>
          <label>
            Strain/variety
            <input type="text" id="doseStrain" placeholder="(optional)" />
          </label>
          <label>
            Route
            <select id="doseRoute">
              <option value="oral">Oral</option>
              <option value="sublingual">Sublingual</option>
              <option value="other">Other</option>
            </select>
          </label>
          <label>
            With food?
            <select id="doseFood">
              <option value="true">Yes</option>
              <option value="false">No</option>
            </select>
          </label>
          <label>
            Set/setting context
            <input type="text" id="doseContext" placeholder="e.g. outdoors, meditation" />
          </label>
          <label>
            Acute notes
            <textarea id="doseNotes" rows="2" placeholder="Any immediate experiences (optional)"></textarea>
          </label>
          <label>
            Adverse event?
            <select id="doseAdverse">
              <option value="false">No</option>
              <option value="true">Yes</option>
            </select>
          </label>
          <label id="doseAdverseNotesLabel" class="hidden">
            Adverse details
            <textarea id="doseAdverseNotes" rows="2" placeholder="Describe adverse events"></textarea>
          </label>
          <button type="button" id="saveDose">Save Dose</button>
        </form>
        <div id="doseList"></div>
      </section>

      <!-- Daily Log -->
      <section id="daily">
        <h2>Daily Log</h2>
        <p class="intro">Complete a quick check-in each day. You can optionally add more detail to capture nuance.</p>
        <form id="dailyForm">
          <fieldset>
            <legend>Quick Log (≈15s)</legend>
            <label>
              Date
              <input type="date" id="dailyDate" />
            </label>
            <label>
              Is this a dose day?
              <select id="dailyDoseDay">
                <option value="true">Yes</option>
                <option value="false">No</option>
              </select>
            </label>
            <label>
              Sleep hours
              <input type="number" id="dailySleep" step="0.1" min="0" max="24" />
            </label>
            <label>
              Sleep quality (1–5)
              <input type="number" id="dailySleepQuality" min="1" max="5" />
            </label>
            <label>
              Rested (1–5)
              <input type="number" id="dailyRested" min="1" max="5" />
            </label>
            <label>
              Mood (1–10)
              <input type="number" id="dailyMood" min="1" max="10" />
            </label>
            <label>
              Anxiety (0–10)
              <input type="number" id="dailyAnxiety" min="0" max="10" />
            </label>
            <label>
              Focus (1–10)
              <input type="number" id="dailyFocus" min="1" max="10" />
            </label>
            <label>
              Energy (1–10)
              <input type="number" id="dailyEnergy" min="1" max="10" />
            </label>
            <label>
              Stress (0–10)
              <input type="number" id="dailyStress" min="0" max="10" />
            </label>
          </fieldset>
          <fieldset>
            <legend>Expanded Log (optional)</legend>
            <label>
              Productivity (1–10)
              <input type="number" id="dailyProductivity" min="1" max="10" />
            </label>
            <label>
              Social connection (1–10)
              <input type="number" id="dailySocial" min="1" max="10" />
            </label>
            <label>
              Libido (1–10)
              <input type="number" id="dailyLibido" min="1" max="10" />
            </label>
            <label>
              GI notes
              <textarea id="dailyGi" rows="2" placeholder="Digestive or GI notes"></textarea>
            </label>
            <label>
              Other notes
              <textarea id="dailyOther" rows="2" placeholder="Any additional symptoms or events"></textarea>
            </label>
            <label>
              Adverse event?
              <select id="dailyAdverse">
                <option value="false">No</option>
                <option value="true">Yes</option>
              </select>
            </label>
            <label id="dailyAdverseNotesLabel" class="hidden">
              Adverse details
              <textarea id="dailyAdverseNotes" rows="2" placeholder="Describe adverse events"></textarea>
            </label>
          </fieldset>
          <button type="button" id="saveDaily">Save Daily Log</button>
        </form>
        <div id="dailyList"></div>
      </section>

      <!-- Weekly Check-in -->
      <section id="weekly">
        <h2>Weekly Check‑in</h2>
        <p class="intro">Once a week, complete these scales to see how your mental health and stress have changed. Compare with your baseline totals.</p>
        <form id="weeklyForm">
          <label>
            Week start date
            <input type="date" id="weeklyDate" />
          </label>
          <fieldset class="scale">
            <legend>PHQ‑9</legend>
            <div id="weekly-phq9"></div>
          </fieldset>
          <fieldset class="scale">
            <legend>GAD‑7</legend>
            <div id="weekly-gad7"></div>
          </fieldset>
          <fieldset class="scale">
            <legend>PSS‑10</legend>
            <div id="weekly-pss10"></div>
          </fieldset>
          <fieldset class="scale">
            <legend>WHO‑5</legend>
            <div id="weekly-who5"></div>
          </fieldset>
          <label>
            Additional notes
            <textarea id="weeklyNotes" rows="2" placeholder="Anything notable this week"></textarea>
          </label>
          <button type="button" id="saveWeekly">Save Weekly</button>
        </form>
        <div id="weeklyList"></div>
      </section>

      <!-- Cognition: Finger Tapping Test and PVT -->
      <section id="cognition">
        <h2>Cognition</h2>
        <p class="intro">Measure changes in motor speed and alertness. Use the Finger Tapping Test regularly to track your tapping speed.</p>
        <!-- Finger Tapping Test -->
        <div class="ftt">
          <h3>Finger Tapping Test (FTT)</h3>
          <p>Select your hand and tap the box as fast as you can for 10 seconds. Complete three trials for each hand. Rest 30–60 seconds between trials.</p>
          <label for="fttHand">Select hand</label>
          <select id="fttHand">
            <option value="dominant">Dominant</option>
            <option value="nondominant">Non‑dominant</option>
          </select>
          <button type="button" id="fttStart">Start Trial</button>
          <div id="fttTimer">Ready</div>
          <div id="fttTapArea" class="tap-area" aria-label="tap area" role="button" tabindex="0">Tap here</div>
          <div id="fttResults"></div>
        </div>
        <!-- Optional PVT placeholder, note instructs to use to measure reaction time -->
        <div class="pvt">
          <h3>Psychomotor Vigilance Task (optional)</h3>
          <p>We haven't implemented the PVT here, but you can track mean and median reaction times with separate apps and record them in notes.</p>
        </div>
      </section>

      <!-- Export / Import -->
      <section id="export">
        <h2>Export &amp; Import</h2>
        <p class="intro">Your data stays on your device. When you want to analyse it or back it up, export to JSON or CSV. You can also paste JSON into the import box to restore data.</p>
        <div class="export-buttons">
          <button type="button" id="exportJson">Export JSON</button>
          <button type="button" id="exportCsv">Export CSVs</button>
          <button type="button" id="showData">Show Data</button>
        </div>
        <div id="exportOutput"></div>
        <h3>Import JSON</h3>
        <textarea id="importData" rows="4" placeholder="Paste your exported JSON here"></textarea>
        <button type="button" id="importJson">Import</button>
      </section>

      <!-- Settings -->
      <section id="settings">
        <h2>Settings &amp; About</h2>
        <p class="intro">Customise the app, change themes, adjust your protocol, and read about how to install the PWA.</p>
        <div class="settings-group">
          <label>
            Protocol
            <select id="settingsProtocol">
              <option value="fadiman">Fadiman</option>
              <option value="stamets">Stamets</option>
              <option value="custom">Custom</option>
            </select>
          </label>
          <div id="settingsCustomPattern" class="hidden">
            <p>Custom 7‑day pattern (1 = dose day, 0 = off):</p>
            <div id="settingsPattern"></div>
          </div>
        </div>
        <div class="settings-group">
          <label>
            Large text mode
            <input type="checkbox" id="settingsLargeText" />
          </label>
        </div>
        <div class="settings-group">
          <label>
            Theme
            <select id="settingsTheme">
              <option value="dark">Dark</option>
              <option value="light">Light</option>
            </select>
          </label>
        </div>
        <div class="settings-group">
          <button type="button" id="settingsClear">Clear all data</button>
        </div>
        <div class="settings-group">
          <h3>Install App</h3>
          <p>You can install this Progressive Web App to your home screen.</p>
          <ol>
            <li>For Android Chrome: tap the browser menu and choose <strong>Install app</strong>.</li>
            <li>For iOS Safari: tap the share icon then <strong>Add to Home Screen</strong>.</li>
          </ol>
          <figure>
            <img src="assets/screenshot-install.png" alt="PWA install illustration" />
          </figure>
        </div>
        <div class="settings-group">
          <h3>About &amp; Disclaimer</h3>
          <p>This app is for educational and self‑tracking purposes only. It is not medical advice. Psychedelics may be illegal where you live and may interact with medications or conditions. Do not drive or operate machinery on dose days. If you experience severe distress or suicidal thoughts, stop dosing and seek professional help immediately.</p>
        </div>
      </section>
    </main>

    <!-- Bottom navigation -->
    <nav id="bottomNav">
      <button data-target="home">Home</button>
      <button data-target="baseline">Baseline</button>
      <button data-target="dosing">Dosing</button>
      <button data-target="daily">Daily</button>
      <button data-target="weekly">Weekly</button>
      <button data-target="cognition">Cognition</button>
      <button data-target="export">Export</button>
      <button data-target="settings">Settings</button>
    </nav>
  </body>
</html>